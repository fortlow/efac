<!-- Vendor JS Files -->
<script src="{{ asset('assets/vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ asset('assets/vendor/php-email-form/validate.js') }}"></script>
<script src="{{ asset('assets/vendor/aos/aos.js') }}"></script>
<script src="{{ asset('assets/vendor/purecounter/purecounter_vanilla.js') }}"></script>
<script src="{{ asset('assets/vendor/glightbox/js/glightbox.min.js') }}"></script>
<script src="{{ asset('assets/vendor/swiper/swiper-bundle.min.js') }}"></script>
<script src="{{ asset('assets/vendor/drift-zoom/Drift.min.js') }}"></script>

<!-- Main JS File -->
<script src="{{ asset('assets/js/main.js') }}"></script>
<script src="{{ asset('assets/js/jquery.min.js') }}"></script>

<!-- CDN JS File -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.7/api/sum().js"></script>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script src="{{ asset('assets/js/bootstrap.js') }}"></script>

{#
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.7/api/sum().js"></script>
#}

<script>

    $(document).ready(function() {

        {% if app.request.requestUri is defined and app.request.requestUri is not null
            and (
            app.request.requestUri matches '/\\/bill/'
            )
        %}
        $('#myTable thead tr')
            .clone(true)
            .addClass('filters')
            .appendTo('#myTable thead');

        let table = $('#myTable').DataTable( {
            drawCallback: function () {
                let api = this.api();
                let sum = 0;
                let formated = 0;
                //to show first th
                //$(api.column(0).footer()).html('TOTAL NET A PAYER :');

                for(let i=5; i<=5;i++)
                {
                    sum = api.column(i, {page:'current'}).data().sum();
                    formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:0});
                    $(api.column(i).footer()).html(formated);
                    $(api.column(i).footer()).css("color", "blue");
                }

                for(let i=6; i<=6;i++)
                {
                    sum = api.column(i, {page:'current'}).data().sum();
                    formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:0});
                    $(api.column(i).footer()).html(formated);
                    $(api.column(i).footer()).css("color", "red");
                }

                for(let i=7; i<=7;i++)
                {
                    sum = api.column(i, {page:'current'}).data().sum();
                    formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:0});
                    $(api.column(i).footer()).html(formated);
                    $(api.column(i).footer()).css("color", "green");
                }

                for(let i=8; i<=8;i++)
                {
                    sum = api.column(i, {page:'current'}).data().sum();
                    formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:0});
                    $(api.column(i).footer()).html(formated);
                    $(api.column(i).footer()).css("color", "black");
                }

                for(let i=9; i<=9;i++)
                {
                    sum = api.column(i, {page:'current'}).data().sum();
                    formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:0});
                    $(api.column(i).footer()).html(formated);
                    $(api.column(i).footer()).css("color", "purple");
                }
            },
            {% if app.user.roles is defined and app.user.roles is not null and 'ROLE_ADMIN' in app.user.roles %}
            dom: 'Blfrtip',
            buttons: [
                'excel', 'pdf', 'print'
            ],
            {% endif %}
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json',
            },
            pageLength: 15,
            lengthMenu: [
                [15, 50, 100, 200, 250, -1],
                [15, 50, 100, 200, 250, 'Toutes']
            ],
            orderCellsTop: true,
            fixedHeader: true,
            initComplete: function () {
                let api = this.api();

                // For each column
                api
                    .columns()
                    .eq(0)
                    .each(function (colIdx) {
                        //alert(colIdx);
                        // Set the header cell to contain the input element
                        let cell = $('.filters th').eq(
                            $(api.column(colIdx).header()).index()
                        );
                        let title = $(cell).text();
                        if (colIdx === 1 || colIdx === 2 || colIdx === 4 || colIdx === 11) {
                            $(cell).html('<input type="text" placeholder="' + title + '" class="w-100 form-control" />');
                        } else {
                            $(cell).html('');
                        }

                        // On every keypress in this input
                        $(
                            'input',
                            $('.filters th').eq($(api.column(colIdx).header()).index())
                        )
                            .off('keyup change')
                            .on('change', function (e) {
                                // Get the search value
                                $(this).attr('title', $(this).val());
                                let regexr = '({search})'; //$(this).parents('th').find('select').val();

                                let cursorPosition = this.selectionStart;
                                // Search the column for that value
                                api
                                    .column(colIdx)
                                    .search(
                                        this.value !== ''
                                            ? regexr.replace('{search}', '(((' + this.value + ')))')
                                            : '',
                                        this.value !== '',
                                        this.value === ''
                                    )
                                    .draw();
                            })
                            .on('keyup', function (e) {
                                e.stopPropagation();

                                $(this).trigger('change');
                                $(this)
                                    .focus()[0]
                                    .setSelectionRange(cursorPosition, cursorPosition);
                            });
                    });
            }
        });
        {% elseif app.request.requestUri is defined and app.request.requestUri is not null
            and (
            app.request.requestUri matches '/\\/proforma/'
            )
        %}
            $('#myTable').DataTable( {
                drawCallback: function () {
                    let api = this.api();
                    let tot = 0;
                    let formated = 0;

                    for(let i=5; i<=5;i++)
                    {
                        console.table(api.column(i, {page:'current'}).data());

                        tot = api.column(i, {page:'current'}).data().sum();
                        formated = parseFloat(tot).toLocaleString(undefined, {minimumFractionDigits:0});
                        $(api.column(i).footer()).html(formated);
                        $(api.column(i).footer()).css("color", "blue");
                    }
                    console.log('tot = '+tot);
                },
                {% if app.user.roles is defined and app.user.roles is not null and 'ROLE_ADMIN' in app.user.roles %}
                dom: 'Blfrtip',
                buttons: [
                    'excel', 'pdf', 'print'
                ],
                {% endif %}
                {% if app.user.roles is defined and app.user.roles is not null and 'ROLE_COMPTABLE' in app.user.roles %}
                dom: 'Blfrtip',
                buttons: [
                    'excel'
                ],
                {% endif %}
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json',
                },
                pageLength: 50,
                lengthMenu: [
                    [50, 100, 150, 200, 250, -1],
                    [50, 100, 150, 200, 250, 'Toutes']
                ],
            });
        {% else %}
            $('#myTable').DataTable({
                {% if app.user.roles is defined and app.user.roles is not null and 'ROLE_ADMIN' in app.user.roles %}
                dom: 'Blfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                {% endif %}
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json',
                },
                pageLength: 50,
                lengthMenu: [
                    [50, 100, 150, 200, 250, -1],
                    [50, 100, 150, 200, 250, 'Toutes']
                ],
            });
        {% endif %}

        // Configuration des notify
        const notyf = new Notyf({
            duration: 4000,
            position: {
                x: 'right',
                y: 'top'
            }, types : [
                {
                    type: 'error',
                    duration: 4000,
                    dismissible: true,
                    background: 'red',
                    icon: {
                        className: 'material-icons',
                        tagName: 'i',
                        text: 'danger'
                    }
                }, {
                    type: 'warning',
                    duration: 4000,
                    background: 'orange',
                    icon: {
                        className: 'material-icons',
                        tagName: 'i',
                        text: 'warning'
                    }
                },
                {
                    type: 'success',
                    duration: 4000,
                    background: 'green',
                    icon: {
                        className: 'material-icons',
                        tagName: 'i',
                        text: 'warning'
                    }
                }
            ]
        });

        // Traitement des messages flashes
        {% for label, messages in app.flashes(['success', 'warning', 'danger']) %}
            {% for message in messages %}
                {% if label == 'success' %}
                    notyf.success('{{ message }}');
                {% elseif label == 'danger' %}
                    notyf.error('{{ message }}');
                {% elseif label == 'warning' %}
                    notyf.open({
                        'type': 'warning',
                        'message': "{{ message }}"
                    });
                {% endif %}
            {% endfor %}
        {% endfor %}
    });

    // Close modal
    function closeModal(nameModal) {
        $('#'+nameModal).modal('toggle');
        //window.location.href  = window.location.href;
    }

    function getInfoProduct(num) {
        //console.log('getInfoProduct('+num+')');
        let refProduct = $('#ref_'+num).val();
        //console.log('refProduct = ('+refProduct+')');

        const tabRefProducts = refProduct.split('-');
        //console.log(tabRefProducts);

        if(tabRefProducts.length === 2) {
            refProduct = tabRefProducts[1];
            //console.log('refProduct 2 = ('+refProduct+')');
        }

        let pathFeed = '/back/get/info/product';

        $.ajax({
            url: pathFeed,
            type: "post",
            dataType: "json",
            data: {
                id: refProduct
            },
            async: true,
            success: function (data) {
                //console.log(data);
                let unitPrice = data[0].price;
                //console.log('unitPrice = '+unitPrice);
                let qte = $('#qte_'+num).val();
                $('#price_'+ num).val(parseInt(unitPrice));
                if ((typeof qte !== 'undefined') && (qte.length > 0)) {
                    let mntHt = (parseInt(qte) * parseInt(unitPrice));
                    $('#mnt_'+ num).val(mntHt);
                }
            },
            error: function (data) {
                //console.log(data);
                $('#price_'+ num).val('0');
            }
        });
    }

    function getInfoService(num) {
        //console.log('getInfoService('+num+')');
        let refService = $('#ref_'+num).val();
        //console.log('refService = ('+refService+')');

        const tabRefServices = refService.split('-');
        //console.log(tabRefServices);

        if(tabRefServices.length === 2) {
            refService = tabRefServices[1];
            //console.log('refService 2 = ('+refService+')');
        }

        let pathFeed = '/back/get/info/service';

        $.ajax({
            url: pathFeed,
            type: "post",
            dataType: "json",
            data: {
                id: refService
            },
            async: true,
            success: function (data) {
                //console.log(data);
                let unitPrice = data[0].pricePerDay;
                let qte = $('#qte_'+num).val();
                //console.log('unitPrice = '+unitPrice);
                //console.log('qte = '+qte);
                $('#price_'+ num).val(parseInt(unitPrice));
                if ((typeof qte !== 'undefined') && (qte.length > 0)) {
                    //console.log('test qte ok');
                    let mntHt = (parseInt(qte) * parseInt(unitPrice));
                    $('#mnt_'+ num).val(mntHt);
                }
            },
            error: function (data) {
                //console.log('error');
                //console.log(data);
                $('#price_'+ num).val('0');
            }
        });
    }

    function getInfoProdService(num) {
        console.log('getInfoProdService('+num+')');
        let refReference = $('#ref_'+num).val();
        console.log('refReference = ('+refReference+')');

        const arrayRef = refReference.split("-")
        console.log(arrayRef);
        console.log('arrayRef[0] = '+arrayRef[0]);
        console.log('arrayRef[1] = '+arrayRef[1]);

        if(arrayRef[0] === 'P') { // Produit
            console.log('Produit - A');
            let pathFeed = '{{ path('app_ajax_get_info_product') }}';
            $.ajax({
                url: pathFeed,
                type: "post",
                dataType: "json",
                data: {
                    id: arrayRef[1]
                },
                async: true,
                success: function (data) {
                    //console.log(data);
                    let unitPrice = data[0].price;
                    //console.log('unitPrice = '+unitPrice);
                    let qte = $('#qte_'+num).val();
                    $('#price_'+ num).val(parseInt(unitPrice));
                    if ((typeof qte !== 'undefined') && (qte.length > 0)) {
                        let mntHt = (parseInt(qte) * parseInt(unitPrice));
                        $('#mnt_'+ num).val(mntHt);
                    }
                },
                error: function (data) {
                    //console.log(data);
                    $('#price_'+ num).val('0');
                }
            });
        } else if(arrayRef[0] === 'S') { // Service
            console.log('Service - B');
            let pathFeed = '{{ path('app_ajax_get_info_service') }}';
            $.ajax({
                url: pathFeed,
                type: "post",
                dataType: "json",
                data: {
                    id: arrayRef[1]
                },
                async: true,
                success: function (data) {
                    //console.log(data);
                    let unitPrice = data[0].pricePerDay;
                    let qte = $('#qte_'+num).val();
                    //console.log('unitPrice = '+unitPrice);
                    //console.log('qte = '+qte);
                    $('#price_'+ num).val(parseInt(unitPrice));
                    if ((typeof qte !== 'undefined') && (qte.length > 0)) {
                        //console.log('test qte ok');
                        let mntHt = (parseInt(qte) * parseInt(unitPrice));
                        $('#mnt_'+ num).val(mntHt);
                    }
                },
                error: function (data) {
                    //console.log('error');
                    //console.log(data);
                    $('#price_'+ num).val('0');
                }
            });
        }
    }

    function updateAmount(num) {
        let qte = $('#qte_'+num).val();
        let unitPrice = $('#price_'+num).val();
        if ((typeof qte !== 'undefined') && (qte.length > 0) && (typeof unitPrice !== 'undefined') && (unitPrice.length > 0)) {
            let mntHt = (parseInt(qte) * parseInt(unitPrice));
            $('#mnt_'+ num).val(mntHt);
        }
    }

    function addLine() {
        let nbline = $('#nbline').val();

        if(parseInt(nbline) < 30) {
            let nextLine = (parseInt(nbline) + parseInt('1'));

            $('#ref_' + nextLine).attr("required", "required");
            $('#qte_' + nextLine).attr("required", "required");
            $('#price_' + nextLine).attr("required", "required");
            $('#mnt_' + nextLine).attr("required", "required");

            $('#line_' + nextLine).css("display", "flex");
            $('#nbline').val(nextLine);
        }
    }

    function deleteLine() {
        let nbline = $('#nbline').val();

        if(parseInt(nbline) > 1) {
            // suppression de l'attribut required
            $('#ref_' + nbline).removeAttr("required");
            $('#qte_' + nbline).removeAttr("required");
            $('#price_' + nbline).removeAttr("required");
            $('#mnt_' + nbline).removeAttr("required");

            // réinitialisation des valeurs
            $('#ref_' + nbline).val("");
            $('#qte_' + nbline).val("");
            $('#price_' + nbline).val("");
            $('#mnt_' + nbline).val("");
            $('#line_' + nbline).css("display", "none");

            let nextLine = (parseInt(nbline) - parseInt('1'));
            $('#nbline').val(nextLine);
        }
    }

    function addInterca() {
        //console.log('addInterca->Ajout intercalaire');

        let nbline = $('#nbline').val();
        let nbinterca = parseInt('0');
        let nbElement = $('#interca').val().length;
        let resInterca;

        //console.log($('#interca').val());
        //console.log('nbElement = ' + nbElement);

        if(nbElement === 0) {
            nbinterca = parseInt('0');
            $('#interca').val('0');
        }

        //console.log('addInterca->nbline = '+nbline);
        //console.log('addInterca->resInterca 1 = '+ $('#interca').val());

        if(parseInt(nbline) > 1 && nbElement === 0) {
            //console.log('A1');
            nbinterca = parseInt('0');
            resInterca = $('#interca').val();
        } else {
            //console.log('A2');
            nbinterca = parseInt(nbline);
            resInterca = $('#interca').val() +','+ nbinterca;
        }

        //console.log('addInterca->nbinterca = '+ nbinterca);

        if(parseInt(nbinterca) < 30) {
            $('#interca_' + nbinterca).attr("required", "required");
            $('#interca_' + nbinterca).css("display", "flex");
        }

        //let resInterca = $('#interca').val() +','+ nbinterca;
        //console.log('-----------------------------------------');
        //console.log('addInterca->resInterca 2 = '+ resInterca);
        $('#interca').val(resInterca);
    }

    function deleteInterca() {
        //console.log('Suppression intercalaire');
        let resInterca = $('#interca').val();
        //console.log('Intercalaire : ' + resInterca);
        const arrayInterca = resInterca.split(",");
        //console.log(arrayInterca);
        //console.log('arrayInterca.length : ' + arrayInterca.length);
        const index = (arrayInterca.length - 1);
        //console.log('index : ' + index);
        let interca = arrayInterca[index];
        //console.log('interca : ' + interca);
        // suppression de l'element
        if (index > -1) {
            arrayInterca.splice(index, 1);
        }
        //console.log("---------------------------------------");
        //console.log(arrayInterca);
        $('#interca_'+interca).css("display", "none");
        $('#interca_'+interca).removeAttr("required");
        $('#interca').val(arrayInterca);
    }

    // Creation d'un client BLR, la gestion du nombre de lignes
    function updateTechLine() {
        //console.log('updateTechLine IN');
        let tabMappedLine = { 1: "one", 2: "two", 3: "three", 4:"four" };
        let nbLine = $('#client_nb_line').val();
        //console.log('updateTechLine - nbLine : '+nbLine);

        if ((typeof nbLine !== 'undefined') && (nbLine.length > 0) && (typeof nbLine !== 'undefined') && (nbLine.length > 0)) {
            //console.log('updateTechLine - nombre de ligne defini => '+nbLine);
            for (let i=1; i<=nbLine; i++) {
                $('#dline_'+i).css("visibility", "visible");
                $('#price_line_'+i).css("visibility", "visible");
                $('#redux_line_'+i).css("visibility", "visible");
                //
                $('#client_line_'+tabMappedLine[i]).attr("required", "required");
                $('#client_price_line_'+tabMappedLine[i]).attr("required", "required");
            }
        } else {
            //console.log('updateTechLine - nombre de ligne non defini.');
            $('#dline_1').css("visibility", "hidden");
            $('#price_line_1').css("visibility", "hidden");
            $('#redux_line_1').css("visibility", "hidden");

            $('#dline_2').css("visibility", "hidden");
            $('#price_line_2').css("visibility", "hidden");
            $('#redux_line_2').css("visibility", "hidden");

            $('#dline_3').css("visibility", "hidden");
            $('#price_line_3').css("visibility", "hidden");
            $('#redux_line_3').css("visibility", "hidden");

            $('#dline_4').css("visibility", "hidden");
            $('#price_line_4').css("visibility", "hidden");
            $('#redux_line_4').css("visibility", "hidden");
            //
            $('#client_line_one').removeAttr("required");
            $('#client_line_two').removeAttr("required");
            $('#client_line_three').removeAttr("required");
            $('#client_line_four').removeAttr("required");
            //
            $('#client_price_line_one').removeAttr("required");
            $('#client_price_line_two').removeAttr("required");
            $('#client_price_line_three').removeAttr("required");
            $('#client_price_line_four').removeAttr("required");
        }
    }
</script>

{#
<script>
    let tophead = document.getElementById('tophead');
    let initialHeight = tophead.clientHeight;

    window.onscroll = function () {
        let distance = window.scrollY;
        let opacity = 1 - distance / initialHeight;
        let height = Math.max(initialHeight - distance / 5, 0);

        // Assurez-vous que l'opacité reste dans la plage de 0 à 1
        opacity = Math.min(1, Math.max(0, opacity));

        // Appliquez les styles à l'élément
        tophead.style.opacity = opacity;
        tophead.style.height = height + 'px';

        if (height < initialHeight) {
            tophead.style.display = 'none';
        } else {
            tophead.style.display = 'block';
        }
    };
</script>
#}

<script>
    $(document).ready(function() {
        let typeAssign = document.getElementById('assignation_type');
        let assignProject = document.getElementById('assignation_project');
        let assignTask = document.getElementById('assignation_task');

        function handleAssignationTypeChange() {
            let type = $(typeAssign).val();

            if (parseInt(type) === 1) {
                $(assignTask).removeClass('readonly d-none');
                $('.assign-task').removeClass('d-none');
                $('.assign-task label').addClass('required');
                $(assignTask).attr('required', true);

                $(assignProject).val('');
                $(assignProject).addClass('readonly d-none');
                $('.assign-project').addClass('d-none');
                $('.assign-project label').removeClass('required');
                $(assignProject).removeAttr('required');
            } else if (parseInt(type) === 2) {
                $(assignProject).removeClass('readonly d-none');
                $('.assign-project').removeClass('d-none');
                $('.assign-project label').addClass('required');
                $(assignProject).attr('required', true);

                $(assignTask).val('');
                $(assignTask).addClass('readonly d-none');
                $('.assign-task').addClass('d-none');
                $('.assign-task label').removeClass('required');
                $(assignTask).removeAttr('required');
            }
        }

        handleAssignationTypeChange();
        $(typeAssign).change(handleAssignationTypeChange);
    });
</script>